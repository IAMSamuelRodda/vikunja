name: Release (Fork)

# Fork-friendly release workflow that:
# - Uses GitHub-hosted runners (no self-hosted)
# - Uploads binaries to GitHub Releases (not S3)
# - Pushes Docker images to GHCR (not Docker Hub)
# - Skips GPG signing

on:
  workflow_call:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  FORK_SUFFIX: "-fork"  # Distinguishes fork releases from upstream

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Git describe
        id: ghd
        uses: proudust/gh-describe@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Docker meta (tag)
        if: ${{ github.ref_type == 'tag' }}
        id: meta-tag
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},suffix=${{ env.FORK_SUFFIX }}
            type=semver,pattern={{major}}.{{minor}},suffix=${{ env.FORK_SUFFIX }}
            type=raw,value=latest${{ env.FORK_SUFFIX }}
      - name: Docker meta (unstable)
        if: ${{ github.ref_type != 'tag' }}
        id: meta-unstable
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=unstable${{ env.FORK_SUFFIX }}
            type=sha,prefix=,suffix=${{ env.FORK_SUFFIX }}
            type=raw,value=${{ steps.ghd.outputs.describe }}${{ env.FORK_SUFFIX }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ github.ref_type == 'tag' && steps.meta-tag.outputs.tags || steps.meta-unstable.outputs.tags }}
          labels: ${{ github.ref_type == 'tag' && steps.meta-tag.outputs.labels || steps.meta-unstable.outputs.labels }}
          build-args: |
            RELEASE_VERSION=${{ steps.ghd.outputs.describe }}${{ env.FORK_SUFFIX }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  binaries:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Git describe
        id: ghd
        uses: proudust/gh-describe@v2
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h /
          # Remove unnecessary pre-installed software
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "=== Disk space after cleanup ==="
          df -h /
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: Download Mage Binary
        uses: actions/download-artifact@v4
        with:
          name: mage_bin
      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend_dist
          path: frontend/dist
      - run: chmod +x ./mage-static
      - name: Install upx
        run: |
          wget https://github.com/upx/upx/releases/download/v5.0.0/upx-5.0.0-amd64_linux.tar.xz
          echo 'b32abf118d721358a50f1aa60eacdbf3298df379c431c3a86f139173ab8289a1  upx-5.0.0-amd64_linux.tar.xz' > upx-5.0.0-amd64_linux.tar.xz.sha256
          sha256sum -c upx-5.0.0-amd64_linux.tar.xz.sha256
          tar xf upx-5.0.0-amd64_linux.tar.xz
          mv upx-5.0.0-amd64_linux/upx /usr/local/bin
          rm -f upx-5.0.0-amd64_linux.tar.xz*
      - name: Setup xgo cache
        uses: actions/cache@v4
        with:
          path: /home/runner/.xgo-cache
          key: xgo-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            xgo-
      - name: Set version
        id: version
        run: |
          VERSION="${{ steps.ghd.outputs.describe }}${{ env.FORK_SUFFIX }}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"
      - name: Build binaries (essential architectures only)
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          export PATH=$PATH:$GOPATH/bin
          go install src.techknowlogick.com/xgo@latest

          # Create output directories
          mkdir -p dist/binaries dist/zip

          # Pull xgo image once
          docker pull ghcr.io/techknowlogick/xgo:latest

          # Build for essential architectures only (not mips/riscv)
          # Linux amd64 + arm64
          xgo -go go-1.23.x \
            -buildmode=default \
            -ldflags "-s -w -X code.vikunja.io/api/pkg/version.Version=${RELEASE_VERSION}" \
            -tags "sqlite_omit_load_extension,osusergo" \
            -out "vikunja-${RELEASE_VERSION}" \
            -dest ./dist/binaries \
            -targets "linux/amd64,linux/arm64" \
            .

          # Darwin (macOS) amd64 + arm64
          xgo -go go-1.23.x \
            -buildmode=default \
            -ldflags "-s -w -X code.vikunja.io/api/pkg/version.Version=${RELEASE_VERSION}" \
            -tags "sqlite_omit_load_extension,osusergo" \
            -out "vikunja-${RELEASE_VERSION}" \
            -dest ./dist/binaries \
            -targets "darwin-10.15/amd64,darwin-10.15/arm64" \
            .

          # Windows amd64 only
          xgo -go go-1.23.x \
            -buildmode=default \
            -ldflags "-s -w -X code.vikunja.io/api/pkg/version.Version=${RELEASE_VERSION}" \
            -tags "sqlite_omit_load_extension,osusergo" \
            -out "vikunja-${RELEASE_VERSION}" \
            -dest ./dist/binaries \
            -targets "windows/amd64" \
            .

          # Make binaries executable and compress with UPX (one at a time to save space)
          for binary in dist/binaries/vikunja-*; do
            chmod +x "$binary" 2>/dev/null || true
            # Skip UPX for darwin binaries (not supported well)
            if [[ "$binary" != *"darwin"* ]]; then
              upx -9 "$binary" || true
            fi
          done

          # Create zip packages
          cd dist/binaries
          for binary in vikunja-*; do
            if [[ "$binary" == *.exe ]]; then
              zip "../zip/${binary%.exe}.zip" "$binary"
            else
              zip "../zip/${binary}.zip" "$binary"
            fi
          done
          cd ../..

          echo "=== Built binaries ==="
          ls -lh dist/binaries/
          echo "=== Zip packages ==="
          ls -lh dist/zip/
      - name: Store Binaries
        uses: actions/upload-artifact@v4
        with:
          name: vikunja_bins
          path: ./dist/binaries/*
      - name: Store Binary Packages
        uses: actions/upload-artifact@v4
        with:
          name: vikunja_bin_packages
          path: ./dist/zip/*

  os-package:
    runs-on: ubuntu-latest
    needs:
      - binaries
    strategy:
      matrix:
        package:
          - rpm
          - deb
          - apk
          - archlinux

    steps:
      - uses: actions/checkout@v4
      - name: Download Vikunja Binary
        uses: actions/download-artifact@v4
        with:
          name: vikunja_bins
          pattern: vikunja-*-linux-amd64
      - name: Git describe
        id: ghd
        uses: proudust/gh-describe@v2
      - name: Download Mage Binary
        uses: actions/download-artifact@v4
        with:
          name: mage_bin
      - name: Set version
        id: version
        run: |
          VERSION="${{ steps.ghd.outputs.describe }}${{ env.FORK_SUFFIX }}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Prepare
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          chmod +x ./mage-static
          ./mage-static release:prepare-nfpm-config
          mkdir -p ./dist/os-packages
          mv ./vikunja-*-linux-amd64 ./vikunja
          chmod +x ./vikunja
      - name: Create package
        id: nfpm
        uses: kolaente/action-gh-nfpm@master
        with:
          packager: ${{ matrix.package }}
          target: ./dist/os-packages/vikunja-${{ github.ref_type == 'tag' && steps.version.outputs.version || 'unstable-fork' }}-x86_64.${{ matrix.package }}
          config: ./nfpm.yaml
      - name: Store OS Packages
        uses: actions/upload-artifact@v4
        with:
          name: vikunja_os_package_${{ matrix.package }}
          path: ./dist/os-packages/*

  desktop:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - name: Git describe
        id: ghd
        uses: proudust/gh-describe@v2
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: desktop/package.json
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: frontend/.nvmrc
          cache: pnpm
          cache-dependency-path: desktop/pnpm-lock.yaml
      - name: Install Linux dependencies
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y libopenjp2-tools rpm libarchive-tools
      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend_dist
          path: frontend/dist
      - name: Build desktop app
        working-directory: desktop
        run: |
          pnpm install --frozen-lockfile --prefer-offline --fetch-timeout 100000
          node build.js "${{ steps.ghd.outputs.describe }}${{ env.FORK_SUFFIX }}" ${{ github.ref_type == 'tag' }}
      - name: Store Desktop Package
        uses: actions/upload-artifact@v4
        with:
          name: vikunja_desktop_packages_${{ matrix.os }}
          path: |
            ./desktop/dist/Vikunja*
            !./desktop/dist/*.blockmap

  create-release:
    runs-on: ubuntu-latest
    needs:
      - binaries
      - os-package
      - desktop
    if: ${{ github.ref_type == 'tag' }}
    permissions:
      contents: write
    steps:
      - name: Download Binaries
        uses: actions/download-artifact@v4
        with:
          name: vikunja_bin_packages

      - name: Download OS Package rpm
        uses: actions/download-artifact@v4
        with:
          name: vikunja_os_package_rpm

      - name: Download OS Package deb
        uses: actions/download-artifact@v4
        with:
          name: vikunja_os_package_deb

      - name: Download OS Package apk
        uses: actions/download-artifact@v4
        with:
          name: vikunja_os_package_apk

      - name: Download OS Package archlinux
        uses: actions/download-artifact@v4
        with:
          name: vikunja_os_package_archlinux

      - name: Download Desktop Package Linux
        uses: actions/download-artifact@v4
        with:
          name: vikunja_desktop_packages_ubuntu-latest

      - name: Download Desktop Package MacOS
        uses: actions/download-artifact@v4
        with:
          name: vikunja_desktop_packages_macos-latest

      - name: Download Desktop Package Windows
        uses: actions/download-artifact@v4
        with:
          name: vikunja_desktop_packages_windows-latest

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            vikunja*.zip
            vikunja*.rpm
            vikunja*.deb
            vikunja*.apk
            vikunja*.archlinux
            Vikunja Desktop*

  generate-swagger-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Mage Binary
        uses: actions/download-artifact@v4
        with:
          name: mage_bin
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: Generate swagger docs
        run: |
          export PATH=$PATH:$GOPATH/bin
          go install github.com/swaggo/swag/cmd/swag@latest
          chmod +x ./mage-static
          ./mage-static generate:swagger-docs
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes_exist=0" >> "$GITHUB_OUTPUT"
          else
            echo "changes_exist=1" >> "$GITHUB_OUTPUT"
          fi
      - name: Commit files
        if: steps.check_changes.outputs.changes_exist != '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -am "[skip ci] Updated swagger docs"
      - name: Push changes
        if: steps.check_changes.outputs.changes_exist != '0'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
